---
- hosts: localhost

  vars:
    # Set to true to upgrade SOC4Kafka binary if it already exists
    Upgrade_SOC4Kafka: true

    # Operating System information
    # Choose from:
    # linux, windows, darwin (= macOS)
    Operating_System: "linux"
    # Choose from:
    # amd64, arm64
    Architecture: "amd64"

    # Kafka and Splunk HEC configuration
    Brokers: "broker1:port1,broker2:port2"
    Topic: "example-topic"
    Encoding: "text"
    Insecure_Skip_Verify: false  # Set to true to skip TLS verification (not recommended for production)
    Splunk_HEC_Token: "your-splunk-hec-token"
    Splunk_HEC_Endpoint: "https://splunk-hec-endpoint:8088/services/collector"
    Source: "example-source"
    Sourcetype: "example-sourcetype"
    Splunk_Index: "example-index"

  tasks:
    - name: Check Splunk HEC connectivity
      uri:
        url: "{{ Splunk_HEC_Endpoint }}"
        method: POST
        headers:
          Authorization: "Splunk {{ Splunk_HEC_Token }}"
          Content-Type: "application/json"
        body: |
          {
            "event": "Quickstart check. SOC4Kafka to Splunk HEC test event",
            "sourcetype": "{{ Sourcetype }}",
            "source": "{{ Source }}",
            "index": "{{ Splunk_Index }}"
          }
        body_format: json
        status_code: 200,201,202
        validate_certs: no

    - name: Set binary destination path
      set_fact:
        otel_binary_file_name: "otelcol_{{ Operating_System | lower }}_{{ Architecture | lower }}{{ '.exe' if Operating_System | lower == 'windows' else '' }}"


    - name: Remove existing otel collector binary if upgrading SOC4Kafka
      file:
        path: "./{{ otel_binary_dest }}"
        state: absent
      when: Upgrade_SOC4Kafka

    - name: Set download URL based on OS and architecture
      set_fact:
        otel_download_url: https://github.com/signalfx/splunk-otel-collector/releases/latest/download/{{ otel_binary_file_name }}

    - name: Download correct otel collector binary
      get_url:
        url: "{{ otel_download_url }}"
        dest: "./{{ otel_binary_file_name }}"
        mode: '0744'


    - name: Download SOC4Kafka configuration file
      get_url:
        url: "https://github.com/splunk/splunk-opentelemetry-collector-for-kafka/blob/main/quickstart/templates/basic_conf_tmpl.yaml.j2"
        dest: "./values.yaml"
        mode: '0644'

    - name: Generate values.yaml from template
      template:
        src: values.yaml.j2
        dest: ./values.yaml
        mode: '0644'

    - name: Display command to start the process
      debug:
        msg: "Run the following command to start the SOC4Kafka Collector: ./{{ otel_binary_file_name }} --config values.yaml"
